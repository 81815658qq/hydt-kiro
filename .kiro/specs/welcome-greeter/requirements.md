# 需求文档

## 简介

迎宾器系统是一个基于计算机视觉的实时人脸检测和问候系统。系统通过USB摄像头实时捕获视频流，检测画面中出现的人脸，并在每个人脸上方显示吉祥祝福语。系统还会统计并记录出现过的不同人数。

## 术语表

- **迎宾器系统（Greeter_System）**：整个应用系统，包括视频采集、人脸检测、祝福语显示和人脸识别功能
- **人脸检测器（Face_Detector）**：使用MediaPipe库检测视频帧中人脸位置的组件
- **人脸特征提取器（Face_Feature_Extractor）**：提取人脸特征用于识别是否为同一人的组件
- **祝福语生成器（Blessing_Generator）**：为检测到的人脸分配吉祥祝福语的组件
- **视频处理器（Video_Processor）**：处理摄像头视频流并渲染祝福语的组件
- **人脸数据库（Face_Database）**：存储已识别人脸特征和图片的组件
- **API服务器（API_Server）**：基于FastAPI的Web服务器，提供视频流和统计接口

## 需求

### 需求 1：视频采集

**用户故事：** 作为系统管理员，我希望系统能够从USB摄像头实时采集视频，以便进行人脸检测和显示。

#### 验收标准

1. WHEN 系统启动时，THE 迎宾器系统 SHALL 连接到默认USB摄像头
2. WHEN 摄像头连接成功时，THE 视频处理器 SHALL 以至少15帧每秒的速率读取视频帧
3. IF 摄像头连接失败，THEN THE 迎宾器系统 SHALL 返回明确的错误信息并优雅退出
4. WHEN 视频帧被读取时，THE 视频处理器 SHALL 保持原始分辨率或调整到合适的处理分辨率

### 需求 2：多人脸实时检测

**用户故事：** 作为用户，我希望系统能够同时检测画面中的多个人脸，以便为每个人显示祝福语。

#### 验收标准

1. WHEN 视频帧包含人脸时，THE 人脸检测器 SHALL 使用MediaPipe检测所有可见人脸
2. WHEN 检测到人脸时，THE 人脸检测器 SHALL 返回每个人脸的边界框坐标
3. WHEN 画面中有多个人时，THE 人脸检测器 SHALL 同时检测并返回所有人脸的位置
4. WHEN 检测到人脸时，THE 人脸检测器 SHALL 提供足够的面部关键点信息用于特征提取

### 需求 3：祝福语显示

**用户故事：** 作为访客，我希望在我的头像上方看到吉祥的祝福语，以便感受到欢迎和祝福。

#### 验收标准

1. WHEN 检测到人脸时，THE 祝福语生成器 SHALL 为该人脸分配一个四字吉祥祝福语
2. THE 祝福语生成器 SHALL 包含至少20个不同的四字吉祥祝福语（如"鸿运当头"、"好运常在"、"福星高照"、"吉祥如意"、"万事如意"、"心想事成"、"步步高升"、"财源广进"、"喜气洋洋"、"笑口常开"）
3. WHEN 渲染视频帧时，THE 视频处理器 SHALL 在每个检测到的人脸上方绘制对应的祝福语
4. WHEN 绘制祝福语时，THE 视频处理器 SHALL 使用清晰可读的字体和颜色
5. WHEN 同一个人持续出现时，THE 祝福语生成器 SHALL 为该人保持相同的祝福语

### 需求 4：人脸特征提取和识别

**用户故事：** 作为系统管理员，我希望系统能够识别已经出现过的人，以便准确统计不同访客的数量。

#### 验收标准

1. WHEN 检测到新人脸时，THE 人脸特征提取器 SHALL 提取该人脸的特征向量
2. WHEN 提取特征后，THE 人脸特征提取器 SHALL 将特征向量与人脸数据库中的已有特征进行比对
3. WHEN 特征相似度超过阈值时，THE 迎宾器系统 SHALL 识别为同一个人
4. WHEN 特征相似度低于阈值时，THE 迎宾器系统 SHALL 识别为新的访客
5. WHEN 识别为新访客时，THE 人脸数据库 SHALL 保存该人脸的特征向量和人脸图片

### 需求 5：访客统计

**用户故事：** 作为系统管理员，我希望系统能够统计出现过的不同访客数量，以便了解迎宾器的使用情况。

#### 验收标准

1. WHEN 识别到新访客时，THE 迎宾器系统 SHALL 增加访客计数
2. WHEN 已识别访客再次出现时，THE 迎宾器系统 SHALL 不增加访客计数
3. THE 迎宾器系统 SHALL 在视频画面上显示当前总访客数量
4. THE 人脸数据库 SHALL 持久化存储已识别访客的人脸图片和特征数据

### 需求 6：Web API服务

**用户故事：** 作为客户端应用，我希望通过Web API访问视频流和统计数据，以便在浏览器或其他设备上查看迎宾器。

#### 验收标准

1. THE API服务器 SHALL 使用FastAPI框架提供HTTP服务
2. THE API服务器 SHALL 提供视频流端点，返回处理后的实时视频流
3. THE API服务器 SHALL 提供统计数据端点，返回当前访客总数
4. WHEN 客户端请求视频流时，THE API服务器 SHALL 以MJPEG或类似格式流式传输视频帧
5. THE API服务器 SHALL 在启动时监听指定端口（默认8000）

### 需求 7：错误处理和系统稳定性

**用户故事：** 作为系统管理员，我希望系统能够稳定运行并妥善处理异常情况，以便提供可靠的服务。

#### 验收标准

1. IF 人脸检测失败，THEN THE 迎宾器系统 SHALL 继续处理下一帧而不崩溃
2. IF 特征提取失败，THEN THE 迎宾器系统 SHALL 记录错误并跳过该人脸
3. IF 摄像头断开连接，THEN THE 迎宾器系统 SHALL 尝试重新连接或返回错误状态
4. WHEN 系统资源不足时，THE 视频处理器 SHALL 降低处理帧率以保持稳定性
5. THE 迎宾器系统 SHALL 记录关键操作和错误到日志文件

### 需求8： 画面做得喜庆一点的设计
