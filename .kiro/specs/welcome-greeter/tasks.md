# 实现计划：迎宾器系统

## 概述

本实现计划将迎宾器系统分解为增量式的开发任务。系统使用Python、FastAPI、OpenCV和MediaPipe构建。每个任务都建立在前一个任务的基础上，确保代码逐步集成，没有孤立的未使用代码。

## 任务列表

- [x] 1. 项目初始化和基础设施
  - 创建项目目录结构
  - 创建requirements.txt，包含依赖：fastapi、uvicorn、opencv-python、mediapipe、numpy、pillow、hypothesis
  - 创建基础配置文件和日志配置
  - 设置测试框架（pytest）
  - _需求：7.5_

- [ ] 2. 实现视频采集模块
  - [ ] 2.1 实现VideoCapture类
    - 实现摄像头连接、帧读取、资源释放功能
    - 实现错误处理（连接失败、读取失败）
    - _需求：1.1, 1.2, 1.3, 1.4_

  - [ ] 2.2 编写VideoCapture单元测试
    - 测试摄像头连接成功场景
    - 测试摄像头不存在时的错误处理
    - 测试帧率获取功能
    - _需求：1.1, 1.3_

  - [ ] 2.3 编写视频帧分辨率属性测试
    - **属性 1：视频帧分辨率一致性**
    - **验证需求：1.4**

- [ ] 3. 实现人脸检测模块
  - [ ] 3.1 实现FaceDetection数据类
    - 定义人脸检测结果的数据结构
    - 实现坐标转换方法
    - _需求：2.2_

  - [ ] 3.2 实现FaceDetector类
    - 使用MediaPipe实现人脸检测
    - 实现多人脸检测功能
    - 实现人脸区域提取
    - _需求：2.1, 2.2, 2.3, 2.4_

  - [ ] 3.3 编写FaceDetector单元测试
    - 使用测试图像验证检测功能
    - 测试无人脸图像返回空列表
    - 测试边界框坐标有效性
    - _需求：2.1, 2.2_

  - [ ] 3.4 编写人脸检测完整性属性测试
    - **属性 1：人脸检测完整性**
    - **验证需求：2.2, 2.4**

  - [ ] 3.5 编写多人脸检测能力属性测试
    - **属性 2：多人脸检测能力**
    - **验证需求：2.1, 2.3**

- [ ] 4. 实现人脸特征提取模块
  - [ ] 4.1 实现FaceFeatureExtractor类
    - 实现简化的特征提取（基于图像哈希或简单CNN）
    - 实现相似度计算（余弦相似度）
    - _需求：4.1, 4.2_

  - [ ] 4.2 编写FaceFeatureExtractor单元测试
    - 测试相同人脸图像的特征一致性
    - 测试不同人脸的特征差异
    - 测试相似度计算范围
    - _需求：4.1_

  - [ ] 4.3 编写特征提取一致性属性测试
    - **属性 5：特征提取一致性**
    - **验证需求：4.1**

  - [ ] 4.4 编写相似度阈值判断属性测试
    - **属性 6：相似度阈值判断正确性**
    - **验证需求：4.3, 4.4**

- [ ] 5. 实现人脸数据库模块
  - [ ] 5.1 实现VisitorRecord数据类
    - 定义访客记录数据结构
    - 实现序列化和反序列化方法
    - _需求：4.5, 5.4_

  - [ ] 5.2 实现FaceDatabase类
    - 实现访客查找功能（基于特征相似度）
    - 实现添加新访客功能
    - 实现访客计数功能
    - 实现数据持久化（保存/加载）
    - _需求：4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.4_

  - [ ] 5.3 编写FaceDatabase单元测试
    - 测试添加新访客
    - 测试查找已存在访客
    - 测试保存和加载功能
    - 测试空数据库场景
    - _需求：4.5, 5.1, 5.2_

  - [ ] 5.4 编写新访客数据持久化属性测试
    - **属性 7：新访客数据持久化**
    - **验证需求：4.5**

  - [ ] 5.5 编写访客计数唯一性属性测试
    - **属性 8：访客计数唯一性**
    - **验证需求：5.1, 5.2**

  - [ ] 5.6 编写数据持久化往返一致性属性测试
    - **属性 9：数据持久化往返一致性**
    - **验证需求：5.4**

- [ ] 6. 实现祝福语生成模块
  - [ ] 6.1 实现BlessingGenerator类
    - 定义至少10个四字吉祥祝福语
    - 实现基于访客ID的一致性分配
    - _需求：3.1, 3.2, 3.5_

  - [ ] 6.2 编写BlessingGenerator单元测试
    - 验证祝福语列表包含至少10个四字词语
    - 测试相同访客ID返回相同祝福语
    - _需求：3.2, 3.5_

  - [ ] 6.3 编写祝福语分配一致性属性测试
    - **属性 3：祝福语分配一致性**
    - **验证需求：3.5**

- [ ] 7. 实现视频渲染模块
  - [ ] 7.1 实现VideoRenderer类
    - 实现中文字体加载
    - 实现祝福语文本绘制（支持中文）
    - 实现人脸边界框绘制
    - 实现统计信息显示
    - _需求：3.3, 3.4, 5.3_

  - [ ] 7.2 编写VideoRenderer单元测试
    - 测试中文文本渲染不抛出异常
    - 测试边界框绘制
    - 测试统计信息显示
    - _需求：3.3, 5.3_

  - [ ] 7.3 编写祝福语渲染完整性属性测试
    - **属性 4：祝福语渲染完整性**
    - **验证需求：3.1, 3.3**

  - [ ] 7.4 编写统计信息显示完整性属性测试
    - **属性 10：统计信息显示完整性**
    - **验证需求：5.3**

- [ ] 8. 实现核心迎宾服务
  - [ ] 8.1 实现GreeterService类
    - 集成所有组件（VideoCapture、FaceDetector、FaceFeatureExtractor、FaceDatabase、BlessingGenerator、VideoRenderer）
    - 实现完整的帧处理流程
    - 实现统计数据获取
    - 实现错误处理和日志记录
    - _需求：1.1, 2.1, 3.1, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 7.1, 7.2, 7.5_

  - [ ] 8.2 编写GreeterService集成测试
    - 测试完整处理流程（使用测试图像）
    - 测试新访客识别和保存
    - 测试已知访客识别
    - 测试统计数据正确性
    - _需求：4.3, 4.4, 4.5, 5.1, 5.2_

  - [ ] 8.3 编写日志记录完整性属性测试
    - **属性 11：日志记录完整性**
    - **验证需求：7.5**

- [ ] 9. 检查点 - 确保核心功能测试通过
  - 运行所有单元测试和属性测试
  - 验证核心业务逻辑正确
  - 如有问题请咨询用户

- [ ] 10. 实现FastAPI Web服务
  - [ ] 10.1 实现FastAPI应用
    - 创建FastAPI应用实例
    - 实现根路径端点（返回HTML页面）
    - 实现视频流端点（/video_feed，返回MJPEG流）
    - 实现统计数据端点（/api/statistics，返回JSON）
    - 实现启动和关闭事件处理
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5_

  - [ ] 10.2 创建前端HTML页面
    - 创建简单的HTML页面显示视频流
    - 显示访客统计信息
    - 添加基本样式
    - _需求：6.2, 6.3_

  - [ ] 10.3 编写FastAPI端点测试
    - 测试根路径返回HTML
    - 测试统计端点返回JSON
    - 测试视频流端点返回正确的Content-Type
    - _需求：6.2, 6.3, 6.4_

- [ ] 11. 错误处理增强
  - [ ] 11.1 完善错误处理
    - 实现摄像头断开重连逻辑
    - 实现各模块的异常捕获和日志记录
    - 实现API错误响应
    - _需求：7.1, 7.2, 7.3_

  - [ ] 11.2 编写错误处理测试
    - 测试人脸检测失败场景
    - 测试特征提取失败场景
    - 测试摄像头断开场景
    - _需求：7.1, 7.2, 7.3_

- [ ] 12. 最终检查点 - 完整系统测试
  - 运行所有测试（单元测试、属性测试、集成测试）
  - 手动测试完整用户场景
  - 验证所有需求已实现
  - 如有问题请咨询用户

- [ ] 13. 文档和部署准备
  - [ ] 13.1 创建README文档
    - 编写项目说明
    - 编写安装和运行指南
    - 编写API文档
    - _需求：所有_

  - [ ] 13.2 创建启动脚本
    - 创建main.py作为应用入口
    - 添加命令行参数支持（端口、摄像头索引等）
    - _需求：6.5_

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 所有测试任务都是必需的，以确保系统质量
